databaseChangeLog:
  - changeSet:
      id: 010-create-user-audit-trigger
      author: Ã…sa Wegelius
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE OR REPLACE FUNCTION audit_user_changes() RETURNS TRIGGER AS $$
              BEGIN
                IF (TG_OP = 'UPDATE' OR TG_OP = 'DELETE') THEN
                  INSERT INTO user_audit (
                    user_id,
                    user_type,
                    email,
                    updated_at,
                    operation_type,
                    change_timestamp,
                    actor_type,
                    actor_id
                  ) VALUES (
                    OLD.user_id,
                    OLD.user_type,
                    OLD.email,
                    OLD.updated_at,
                    TG_OP,
                    now(),
                    NULL,
                    NULL
                  );
                END IF;
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

        - createTrigger:
            triggerName: trg_user_audit
            tableName: user
            after: true
            events:
              - update
              - delete
            forEachRow: true
            referencedTableName: user_audit
            procedureName: audit_user_changes
